<?phpif (!(defined('IN_IA'))) {    exit('Access Denied');}class Api_Part_Order extends WeModuleWxapp {    /**     * 订单列表     */    public function order_list() {        global $_GPC, $_W;        $page = $_GPC['page'] ?: 1;        $pageSize = 10;        $beginPage = ($page-1)*$pageSize;        $sql = "SELECT * FROM ".tablename('monai_market_part_order')." WHERE uniacid={$_W['uniacid']} AND uid={$_GPC['uid']} AND status={$_GPC['status']} " .            "order by `save_time` desc LIMIT {$beginPage},{$pageSize} ";        $list = pdo_fetchall($sql);        if ($list) {            // 获取车型            $arr = pdo_getall('monai_market_class', array('uniacid'=>$_W['uniacid']), array('id', 'name'), '', array('sort DESC'));            $car_type = array();            foreach ($arr as $v) {                $car_type[ $v['id'] ] = $v['name'];            }            $part_type = array(                1 => '原厂全新',                2 => '副厂全新',                3 => '原车拆件',            );            // 组装数据            foreach ($list as &$v) {                $v['car_type'] = $car_type[ $v['car_type'] ];                $v['part_type'] = $part_type[ $v['part_type'] ];                $v['part_img'] = tomedia($v['part_img']);                $v['create_time'] = date('Y.m.d', $v['create_time']);            }            unset($v);        }        return $this->result(0, '', $list);    }    /**     * 订单支付前设置     */    public function pay_set() {        global $_GPC, $_W;        // 获取地址        $address = pdo_get('monai_market_member_address', array('uniacid'=>$_W['uniacid'], 'uid'=>$_GPC['uid']));        // 获取订单        $order = pdo_get('monai_market_part_order', array('id'=>$_GPC['id'], 'uniacid'=>$_W['uniacid'], 'uid'=>$_GPC['uid']));        if (empty($order)) {            return $this->result(500, '非法访问！');        }        $order['part_img'] = tomedia($order['part_img']); // 补全图片路径        return $this->result(0, '', array('order'=>$order, 'address'=>$address));    }    /**     * 更新地址     */    public function address_save() {        global $_GPC, $_W;        $data = array(            'name' => $_GPC['name'],            'tel' => $_GPC['tel'],            'address' => $_GPC['address'],            'create_time' => time()        );        $address = pdo_get('monai_market_member_address', array('uniacid'=>$_W['uniacid'], 'uid'=>$_GPC['uid']));        if ($address) {            $res = pdo_update('monai_market_member_address', $data, array('id'=>$address['id']));        } else {            $data['uniacid'] = $_W['uniacid'];            $data['uid'] = $_GPC['uid'];            $res = pdo_insert('monai_market_member_address', $data);        }        if ($res === false) {            return $this->result(500, '地址保存失败');        }        return $this->result(0, '');    }    /**     * 支付回调     */    public function pay_callback() {        global $_GPC, $_W;        $uid = $_GPC['uid'];        $uniacid = $_W['uniacid'];        $oid = $_GPC['oid'];        $fid = $_GPC['fid'];        $order = pdo_get('monai_market_part_order', array('id'=>$oid, 'uid'=>$uid, 'uniacid'=>$uniacid), array('part_price'));        $n = 0;        do {            pdo_begin();            // 更新配件订购订单数据            $data = array(                'status' => 3,                'save_time' => time()            );            $res1 = pdo_update('monai_market_part_order', $data, array('id'=>$oid, 'uid'=>$uid, 'uniacid'=>$uniacid));            // 更新支付订单数据            $data = array(                'status' => 1,                'pay_time' => time(),                'pay_money' => $order['part_price'],            );            $res2 = pdo_update('monai_market_finance', $data, array('id'=>$fid, 'uid'=>$uid, 'uniacid'=>$uniacid));            if ($res1 && $res2) {                pdo_commit();                $n = 1;            } else {                pdo_rollback();            }        } while ($n == 0);        return $this->result(0, '');    }    /**     * 确认收货操作     */    public function confirm_order() {        global $_GPC, $_W;        $uid = $_GPC['uid'];        $id = $_GPC['id'];        $uniacid = $_W['uniacid'];        $order = pdo_get('monai_market_part_order', array('id'=>$id, 'uid'=>$uid, 'uniacid'=>$uniacid));        if (empty($order)) {            return $this->result(500, '非法访问！');        }        $data = array(            'status' => 5,            'save_time' => time()        );        $res = pdo_update('monai_market_part_order', $data, array('id'=>$id, 'uid'=>$uid, 'uniacid'=>$uniacid));        if ($res === false) {            return $this->result(1, '操作失败，请稍后再试！');        }        return $this->result(0, '');    }}