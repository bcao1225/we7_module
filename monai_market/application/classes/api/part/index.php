<?phpif (!(defined('IN_IA'))) {    exit('Access Denied');}class Api_Part_Index extends WeModuleWxapp{    /**     * 获取车辆类型     */    public function get_car_type()    {        global $_W;        $class = pdo_getall('monai_market_class', array('uniacid' => $_W['uniacid']), array('id', 'name'), '', array('sort DESC'));        return $this->result(0, '', $class);    }    /**     * 解密获取用户手机号     */    public function get_tel()    {        global $_GPC;        $account_api = WeAccount::create();        $encrypt_data = $_GPC['encryptedData'];        $iv = $_GPC['iv'];        if (empty($encrypt_data) || empty($iv)) {            $account_api->result(1, '非法访问！');        }        if (empty($_SESSION['session_key'])) {            $account_api->result(1, '请先登录！');        }        $phone = $account_api->pkcs7Encode($encrypt_data, $iv);        if ($phone && $phone['phoneNumber']) {            return $this->result(0, '', $phone['phoneNumber']);        }        return $this->result(500, '手机号码获取失败！请手动输入', $phone);    }    /**     * 汽配订购订单添加     */    public function order_add()    {        global $_GPC, $_W;        $now_time = time();        $data = array(            'uniacid' => $_W['uniacid'],            'uid' => $_GPC['uid'],            'part_img' => $_GPC['part_img'],            'part_name' => $_GPC['part_name'],            'car_type' => $_GPC['car_type'],            'car_year' => $_GPC['car_year'],            'part_type' => $_GPC['part_type'],            'user_tel' => $_GPC['user_tel'],            'order_sn' => $this->build_order_no(),            'create_time' => $now_time,            'save_time' => $now_time        );        $res = pdo_insert('monai_market_part_order', $data);        if ($res) {            return $this->result(0, '');        } else {            return $this->result(1, '添加失败，请重新尝试！');        }    }    /**     * 生成订单号     * @return string     */    private function build_order_no()    {        $yCode = array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J');        $orderSn = $yCode[intval(date('Y')) - 2017] . strtoupper(dechex(date('m'))) . date('d') . substr(time(), -5) . substr(microtime(), 2, 5) . sprintf('%02d', rand(0, 99));        return $orderSn;    }    /**     * 通过填入一级分类，搜索获取具体的车辆信息     */    public function one_classify_by_cars()    {        global $_GPC, $_W;        $sql = "SELECT * FROM ims_monai_market_brand WHERE pid>0 AND name LIKE '%" . $_GPC['name'] . "%'";        //通过传入一级分类，搜素所有匹配的一级分类        $brand_list = pdo_fetchall($sql);        //通过一级分类获取二级分类信息        foreach ($brand_list as $key => $item) {            $cars = pdo_getall('ims_monai_market_car_detail', ['brand2' => $item['id'],'status'=>3]);            foreach ($cars as $index=>$car){                $cars[$index]['carimg'] = $_W['attachurl'] . $car['carimg'];                $cars[$index]['brand'] = pdo_get('ims_monai_market_brand',['id'=>$car['brand']]);                $cars[$index]['brand2'] = pdo_get('ims_monai_market_brand',['id'=>$car['brand2']]);                $cars[$index]['brand3'] = pdo_get('ims_monai_market_brand',['id'=>$car['brand3']]);            }            $brand_list[$key]['cars'] = $cars;        }        $this->result(0, '获取成功', $brand_list);    }}