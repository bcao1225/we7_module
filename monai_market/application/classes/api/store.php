<?php/** * Created by PhpStorm. * User: Administrator * Date: 2018/5/7 * Time: 15:07 */if (!(defined('IN_IA'))){    exit('Access Denied');}class Api_Store extends WeModuleWxapp{    /**     * 修改用户信息     */    public function getVip(){        global $_GPC, $_W;        $detail = pdo_get('monai_market_enter',['uniacid'=>$_W['uniacid']]);        return $this->result(0, '', $detail);    }    /**     * 推广中心     */    public function detail(){        global $_GPC, $_W;        $detail = pdo_get('monai_market_member',['uniacid'=>$_W['uniacid'],'uid' => $_GPC['uid']]);        if($detail['is_vip']==1 && $detail['end_time']>time()){            $detail['store_img']= tomedia($detail['store_img']);        }        // 关注用户总数        $gtotal= pdo_fetch("SELECT count(*) as total FROM ".tablename('monai_market_follow_logs')." WHERE uid = {$_GPC['uid']} and `type`=1 and uniacid={$_W['uniacid']} and status = 1 LIMIT 1");        // 粉丝总数        $ftotal= pdo_fetch("SELECT count(*) as total FROM ".tablename('monai_market_follow_logs')." WHERE ucar_id = {$_GPC['uid']} and `type`=1 and uniacid={$_W['uniacid']}  and status = 1 LIMIT 1");        // 发布总数        $fbtotal= pdo_fetch("SELECT count(*) as total FROM ".tablename('monai_market_car_detail')." WHERE uid = {$_GPC['uid']} and uniacid={$_W['uniacid']} LIMIT 1");        $where=" mmfl.uid=".$_GPC['uid'].' AND mmfl.type=2 AND mmfl.status=1 AND mmfl.uniacid='.$_W['uniacid'].' AND mmcd.id!=\'\'';        $sql='SELECT count(*) as total FROM'.tablename('monai_market_follow_logs')            .' AS mmfl LEFT JOIN '.tablename('monai_market_car_detail').' AS mmcd ON mmfl.ucar_id=mmcd.id  WHERE '.$where.'  ORDER BY mmcd.id DESC ';        $mtotal=pdo_fetch($sql);        $result = [            'user' => $detail,            'mtotal' =>$mtotal['total'] ,            'gtotal' =>$gtotal['total'] ,            'ftotal' =>$ftotal['total'] ,            'fbtotal' =>$fbtotal['total'] ,        ];        return $this->result(0, '', $result);    }    /**     * 推广用户     */    public function fans(){        global $_GPC, $_W;        $pageSize = 10;        $page = $_GPC['page'] ?: 1;        $beginPage = ($page-1)*$pageSize;        $query = "SELECT * FROM ".tablename('monai_market_member')." WHERE parent_uid={$_GPC['uid']} AND uid !={$_GPC['uid']} AND uniacid={$_W['uniacid']} order by user_id desc LIMIT {$beginPage},{$pageSize} ";        $list = pdo_fetchall($query);        if($list){            foreach ($list as $k => $v){                $list[$k]['create_time'] = date('Y.m.d',$v['create_time']);            }            return $this->result(0, '', $list);        }else{            return $this->result(0, '', false);        }    }    /**     * 提现明细     */    public function getWithdraw(){        global $_GPC, $_W;        $pageSize = 9;        $page = $_GPC['page'] ?: 1;        $beginPage = ($page-1)*$pageSize;        $query = "SELECT * FROM ".tablename('monai_market_withdraw')." WHERE uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']} order by id desc LIMIT {$beginPage},{$pageSize} ";        $list = pdo_fetchall($query);        if($list){            foreach ($list as $k => $v){                $list[$k]['create_time'] = date('Y.m.d H:i',$v['create_time']);            }            return $this->result(0, '', $list);        }else{            return $this->result(0, $query, false);        }    }    /**     * 佣金记录     */    public function getAccount(){        global $_GPC, $_W;        $pageSize = 5;        $page = $_GPC['page'] ?: 1;        $beginPage = ($page-1)*$pageSize;        //$query = "SELECT * FROM ".tablename('monai_market_withdraw')." WHERE uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']} order by id desc LIMIT {$beginPage},{$pageSize} ";        $query = "SELECT ma.*,mm.`nickname`,mm.`head_image` FROM ".tablename('monai_market_account')." ma         LEFT JOIN ".tablename('monai_market_member')." mm ON ma.uid=mm.uid         WHERE ma.parent_uid={$_GPC['uid']}  AND ma.uniacid={$_W['uniacid']}        ORDER BY ma.`id` DESC         LIMIT {$beginPage},{$pageSize} ";        $list = pdo_fetchall($query);        if($list){            foreach ($list as $k => $v){                $list[$k]['create_time'] = date('Y.m.d H:i',$v['create_time']);            }            return $this->result(0, '', $list);        }else{            return $this->result(0, '', false);        }    }    /**     * 获取总额     */    public function getAccountTotal(){        global $_GPC, $_W;        $query  = "SELECT SUM(brokerage) AS brokerage,SUM(account) AS account                     FROM  ".tablename('monai_market_account')."                    WHERE parent_uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']}";        $result = pdo_fetch($query);        if($result){            return $this->result(0, '', $result);        }else{            return $this->result(0, '', ['brokerage'=>0,'account'=>0]);        }    }    /**     * 获取推广信息     */    public function getSaleinfo(){        global $_GPC, $_W;        $query  = "SELECT SUM(brokerage) AS brokerage                    FROM  ".tablename('monai_market_account')."                    WHERE parent_uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']}";        $brokerage = pdo_fetch($query);        $query  = "SELECT SUM(account) AS account                    FROM ".tablename('monai_market_withdraw')."                    WHERE uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']}";        $withdraw= pdo_fetch($query);        $query  = "SELECT COUNT(*) AS account                    FROM ".tablename('monai_market_member')."                    WHERE parent_uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']}";        $number= pdo_fetch($query);        $result = [            'brokerage' => ($brokerage && $brokerage['brokerage']) ? $brokerage['brokerage'] : 0.00,            'withdraw' => ($withdraw && $withdraw['account']) ? $withdraw['account'] : 0.00,            'number' => ($number && $number['account']) ? $number['account'] : 0,        ];        return $this->result(0, '', $result);    }    /**     * 余额     */    public function getBalance(){        global $_GPC, $_W;        $query  = "SELECT balance,account                    FROM ".tablename('monai_market_member')."                    WHERE uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']}";        $result = pdo_fetch($query);        return $this->result(0, '', $result);    }    /**     * 提现     */    public function addWithdraw(){        global $_GPC, $_W;        $query  = "SELECT balance,account                    FROM ".tablename('monai_market_member')."                    WHERE uid={$_GPC['uid']}  AND uniacid={$_W['uniacid']}";        $result = pdo_fetch($query);        if(!$result){            return $this->result(2, '用户不存在', '');        }        if(empty($_GPC['balance']))        {            return $this->result(2, '提现金额不小于1元', '');        }        if(empty($_GPC['balance']))        {            return $this->result(2, '提现金额不小于1元', '');        }        if($_GPC['balance'] > $result['balance'] ){            return $this->result(2, '余额不足', '');        }        $data = [            'uid' => $_GPC['uid'],            'uniacid'=>$_W['uniacid'],            'detail' => '提现',            'create_time' => $_SERVER["REQUEST_TIME"],            'account' => $_GPC['balance'],            'status' => 0        ];        pdo_begin();        $res = pdo_insert('monai_market_withdraw',$data);        if(empty($res)){            pdo_rollback();        }        $result = pdo_update('monai_market_member',['balance'=>$result['balance']-$_GPC['balance'],'account'=>$result['account']+$_GPC['balance']],['uid'=>$_GPC['uid'],'uniacid'=>$_W['uniacid']]);        pdo_commit();        if (!empty($result)) {            return $this->result('', '申请成功', '1');        }else{            pdo_rollback();        }    }    //发送模板消息通用方法    public function send_tel_news()    {        global $_GPC, $_W;        $wx_tel = pdo_get('monai_market_wx_message_tmp',array('uniacid'=>$_W['uniacid'],'type'=>$_GPC['tel_type']));        if(empty($wx_tel['content']))        {            return $this->result(2, '', '');        }        $user = pdo_get('mc_mapping_fans',array('uniacid'=>$_W['uniacid'],'uid'=>$_GPC['uid']), array('openid'));        $data = array(            'touser' => $user['openid'],            'template_id' => $wx_tel['content'],            'page' => '',            'form_id' => $_GPC['formid'],            'emphasis_keyword' => '',        );        if($_GPC['tel_type']==2)        {            $data['keyword'] = array(                '认证通过',                '门店认证',                date('Y年m月d号 H时',time()),            );        }else if($_GPC['tel_type']==3)        {            $data['keyword'] = array(                '置顶成功',                date('Y年m月d号 H时',time()),                '车辆置顶',            );        }        Message::Instance()->send($data);        return $this->result('', '', '');    }}