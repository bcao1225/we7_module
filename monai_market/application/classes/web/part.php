<?phpif (!(defined('IN_IA'))) {    exit('Access Denied');}class Web_Part extends Web_Base {    public function order_list() {        global $_W, $_GPC;        $uniacid = $_W['uniacid'];        $page = max(1, intval($_GPC['page']));        $size = 6;        $n = ($page - 1) * $size;        // 组装条件        $order_sn = $_GPC['order_sn'];        $status = $_GPC['status'];        $where = '';        if ($order_sn) {            $where .= " and order_sn='{$order_sn}'";        }        if ($status > 0) {            $where .= " and status={$status}";        }        $total = pdo_fetchcolumn("select count(*) from ".tablename('monai_market_part_order')." where `uniacid`={$uniacid} {$where}");        $list=pdo_fetchall("select * from ".tablename('monai_market_part_order')." where `uniacid`={$uniacid} {$where} order by id desc LIMIT " . $n . ",{$size}");        $pager = pagination2($total, $page, $size);        // 状态名称        $status_name = array(            1 => '待报价',            2 => '待支付',            3 => '待发货',            4 => '待收货',            5 => '已完成'        );        // 配件类型名称        $part_type_name = array(            1 => '原厂全新',            2 => '副厂全新',            3 => '原车拆件',        );        // 车型名称        $arr = pdo_getall('monai_market_class', array('uniacid'=>$uniacid), array('id', 'name'));        $car_type_name = array();        foreach ($arr as $v) {            $car_type_name[ $v['id'] ] = $v['name'];        }        include $this->template();    }    /**     * 查看大图     */    public function see_img() {        global $_GPC;        $line = pdo_get('monai_market_part_order', array('id'=>$_GPC['id']), array('part_img'));        include $this->template();    }    /**     * 详情     */    public function info() {        global $_GPC, $_W;        $line = pdo_get('monai_market_part_order', array('id'=>$_GPC['id']));        // 状态名称        $status_name = array(            1 => '待报价',            2 => '待支付',            3 => '待发货',            4 => '待收货',            5 => '已完成'        );        // 配件类型名称        $part_type_name = array(            1 => '原厂全新',            2 => '副厂全新',            3 => '原车拆件',        );        // 车型名称        $type = pdo_get('monai_market_class', array('uniacid'=>$_W['uniacid'], 'id'=>$line['car_type']), array('name'));        // 组装数据        $line['status'] = $status_name[ $line['status'] ];        $line['part_type'] = $part_type_name[ $line['part_type'] ];        $line['car_type'] = $type['name'];        $line['part_img'] = tomedia($line['part_img']);        $line['create_time'] = date('Y-m-d H:i', $line['create_time']);        include $this->template();    }    /**     * 报价     */    public function offer_price() {        global $_GPC, $_W;        if($_W['ispost']){            $data = array(                'part_price' => $_GPC['price'],                'status' => 2,                'save_time' => time()            );            pdo_update('monai_market_part_order', $data, array('id'=>$_GPC['id']));            exit;        }        include $this->template();    }    /**     * 发货     */    public function delivery() {        global $_GPC, $_W;        if($_W['ispost']){            $data = array(                'express_name' => $_GPC['express_name'],                'waybill_sn' => $_GPC['waybill_sn'],                'status' => 4,                'save_time' => time()            );            $res = pdo_update('monai_market_part_order', $data, array('id'=>$_GPC['id']));            if ($res) {                // 订单                $order = pdo_get('monai_market_part_order', array('id'=>$_GPC['id']));                // 用户信息                $user = pdo_get('mc_mapping_fans',array('uniacid'=>$_W['uniacid'],'uid'=>$order['uid']), array('openid'));                // 模板id                $tmp = pdo_get('monai_market_wx_message_tmp', array('uniacid'=>$_W['uniacid'], 'type'=>1), array('content'));                $data = array(                    'touser' => $user['openid'],                    'template_id' => $tmp['content'],                    'page' => 'pages/part/order/index?status=4',                    'form_id' => $order['formid'],                    'emphasis_keyword' => '',                    'keyword' => array(                        $order['part_name'],                        $order['express_name'],                        $order['receive_address'],                        $order['waybill_sn']                    )                );                Message::Instance()->send($data);            }            exit;        }        include $this->template();    }}